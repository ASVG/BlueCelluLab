[tox]
envlist = py3-test
indexserver =
    default = https://bbpteam.epfl.ch/repository/devpi/bbprelman/dev/+simple
[testenv]
envdir =
    py27{-test,-v5,-v6,-thal,-style,-docs,}: {toxworkdir}/py27
    py3{-test,-v5,-v6,-thal,-style,-docs,}: {toxworkdir}/py3
extras =
    bbp
passenv = KRB5CCNAME DISPLAY https_proxy USER
deps =
    nose
    nosepipe
    pep8
    coverage
    sh
    docs,upload_docs,firefox: sphinx
    docs,upload_docs,firefox: sphinx-bluebrain-theme==0.1.0
    upload_docs: docs-internal-upload>=0.0.8
    numpydoc
    pycodestyle
    pyrsistent==0.16.1
download = true
whitelist_externals =
    make
    find
    echo
    upload2repo
    export
    cmake
setenv =
    HOC_LIBRARY_PATH={envdir}/.neurodamus/local/neurodamus-core/hoc
    BGLIBPY_MOD_LIBRARY_PATH={envdir}/.neurodamus/local/x86_64/.libs/libnrnmech.so

    PYTHONPATH={envdir}/.neuronpy/local/lib/python:{envdir}/.neuronpy/local/lib64/python
    TOX_ENVBINDIR={envbindir}
    TOX_NRNBINDIR=../.neuronpy/local/x86_64/bin/ 
    OMP_NUM_THREADS=1
commands =
    pip --version
    make clean
    ./.install_neuron.sh {envdir}/.neuronpy/src {envdir}/.neuronpy/local {basepython}

    make toxbinlinks
    
    ./.install_neurodamus.sh {envdir}/.neurodamus/local
    test,v5: ./.compile_mod.sh {envdir}/.neurodamus/local neocortex/mod/v5

    test: nosetests --processes=50 --process-timeout=600 -vsx -A "not gpfs and not v6" []
    debugtest: nosetests -vsx -a debugtest []
    v5: nosetests --processes=50 --process-timeout=600 -vsx -a v5 []
    
    v6: ./.compile_mod.sh {envdir}/.neurodamus/local neocortex/mod/v6
    v6: nosetests --processes=50 --process-timeout=600 -vsx -a v6 []

    thal: ./.compile_mod.sh {envdir}/.neurodamus/local thalamus/mod
    thal: nosetests --processes=50 --process-timeout=600 -vsx -a thal []

    style: pycodestyle bglibpy --ignore=E501,W504,W503,E741

    docs,upload_docs,firefox: sphinx-build -Q -b html -d {envtmpdir}/doctrees docs/source  {envtmpdir}/html
    firefox: firefox {envtmpdir}/html/index.html
    upload_docs: python ./.upload_docs.py {envtmpdir}/html
    upload_docs: docs-internal-upload --docs-path {envtmpdir}/html --use-major-minor-only --no-duplicate-version-error

    devpi: make devpi
